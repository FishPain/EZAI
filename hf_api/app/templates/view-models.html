<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Model</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body>
    <div class="container-fluid">
        <div class="row mx-5 my-5">
            <div class="col-lg-2 d-md-block bg-light sidebar p-4">
                <h4 class="text-center mb-4">Filters</h4>
                <ul class="list-group">
                    <!-- Model Type Filters -->
                    <li class="list-group-item">
                        <input class="form-check-input me-1" type="checkbox" id="allCheckbox" onchange="filterModels()">
                        <label class="form-check-label" for="allCheckbox">All Types</label>
                    </li>
                    <li class="list-group-item">
                        <input class="form-check-input me-1" type="checkbox" id="tensorflowCheckbox"
                            onchange="filterModels()">
                        <label class="form-check-label" for="tensorflowCheckbox">TensorFlow</label>
                    </li>
                    <li class="list-group-item">
                        <input class="form-check-input me-1" type="checkbox" id="pytorchCheckbox"
                            onchange="filterModels()">
                        <label class="form-check-label" for="pytorchCheckbox">PyTorch</label>
                    </li>

                    <!-- Registered Status Filter -->
                    <li class="list-group-item mt-3">
                        <input class="form-check-input me-1" type="checkbox" id="registeredCheckbox"
                            onchange="filterModels()">
                        <label class="form-check-label" for="registeredCheckbox">Registered</label>
                    </li>
                    <li class="list-group-item">
                        <input class="form-check-input me-1" type="checkbox" id="unregisteredCheckbox"
                            onchange="filterModels()">
                        <label class="form-check-label" for="unregisteredCheckbox">Unregistered</label>
                    </li>
                </ul>
            </div>

            <!-- Main content area -->
            <main class="col-lg-8 ms-sm-auto px-md-4">
                <div class="container border p-4 bg-white shadow rounded">
                    <div class="d-flex justify-content-between mb-4">
                        <ul class="nav nav-tabs">
                            <li class="nav-item">
                                <a class="nav-link active" aria-current="page" href="#">View Models</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="/view-contributors">Top Model Contributors</a>
                            </li>
                        </ul>
                        <!-- Back Button -->
                        <button onclick="goBack()" class="btn btn-secondary">Back</button>
                    </div>

                    <div class="container">
                        <table class="table table-striped table-hover" id="modelTable">
                            <thead>
                                <tr>
                                    <th onclick="sortTable(0)" scope="col">Model Name</th>
                                    <th onclick="sortTable(1)" scope="col">Model Type</th>
                                    <th onclick="sortTable(2)" scope="col">Model Version</th>
                                    <th onclick="sortTable(3)" scope="col">Upload Date</th>
                                    <th onclick="sortTable(4)" scope="col">Inference Counts</th>
                                    <th onclick="sortTable(5)" scope="col">Registered</th>
                                </tr>
                            </thead>
                            <tbody class="table-group-divider">
                                <!-- Model data will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </main>
            <div class="col-lg-2"></div>
        </div>
    </div>

    <!-- Bootstrap 5 JS and dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        let models = [];

        // Fetch data from the API and populate the table
        async function fetchModelData() {
            try {
                const response = await fetch(`http://localhost:5001/v1/api/model_manager/all`);
                const data = await response.json();

                if (data.body && data.body.body) {
                    models = data.body.body; // Store models in a global variable
                    populateModelTable(models);
                } else {
                    console.error("Invalid data format", data);
                }
            } catch (error) {
                console.error("Error fetching model data:", error);
            }
        }

        // Function to populate the table with model data
        function populateModelTable(modelData) {
            const tbody = document.getElementById('modelTable').getElementsByTagName('tbody')[0];
            tbody.innerHTML = '';  // Clear any existing rows

            modelData.forEach(model => {
                const row = tbody.insertRow();
                row.setAttribute('scope', 'row');
                row.insertCell(0).textContent = model.model_name;
                row.insertCell(1).textContent = model.model_type;
                row.insertCell(2).textContent = model.model_version;
                row.insertCell(3).textContent = new Date(model.upload_datetime).toLocaleDateString();
                row.insertCell(4).textContent = model.run_count;
                row.insertCell(5).textContent = model.registered ? 'Yes' : 'No';
            });
        }

        // Function to filter the table based on selected checkboxes
        function filterModels() {
            const allCheckbox = document.getElementById('allCheckbox').checked;
            const tensorflowCheckbox = document.getElementById('tensorflowCheckbox').checked;
            const pytorchCheckbox = document.getElementById('pytorchCheckbox').checked;
            const registeredCheckbox = document.getElementById('registeredCheckbox').checked;
            const unregisteredCheckbox = document.getElementById('unregisteredCheckbox').checked;

            const filteredModels = models.filter(model => {
                // Check Model Type
                if (!allCheckbox) {
                    const modelType = model.model_type.toLowerCase();
                    if ((tensorflowCheckbox && modelType !== 'tensorflow') &&
                        (pytorchCheckbox && modelType !== 'pytorch')) {
                        return false;
                    }
                }

                // Check Registered Status
                if (registeredCheckbox && !model.registered) return false;
                if (unregisteredCheckbox && model.registered) return false;

                return true; // Passes all checks
            });

            populateModelTable(filteredModels); // Re-populate the table with filtered data
        }

        // Sort function to sort the table columns
        function sortTable(columnIndex) {
            const tbody = document.getElementById("modelTable").getElementsByTagName("tbody")[0];
            const rows = Array.from(tbody.rows);
            let sortDirection = "asc";

            if (tbody.dataset.sortedColumn == columnIndex) {
                sortDirection = tbody.dataset.sortDirection === "asc" ? "desc" : "asc";
            }
            tbody.dataset.sortedColumn = columnIndex;
            tbody.dataset.sortDirection = sortDirection;

            rows.sort((rowA, rowB) => {
                const cellA = rowA.cells[columnIndex].textContent.toLowerCase();
                const cellB = rowB.cells[columnIndex].textContent.toLowerCase();

                if (columnIndex === 3) { // Sorting by date
                    return sortDirection === "asc"
                        ? new Date(cellA) - new Date(cellB)
                        : new Date(cellB) - new Date(cellA);
                } else {
                    return sortDirection === "asc"
                        ? cellA.localeCompare(cellB)
                        : cellB.localeCompare(cellA);
                }
            });

            // Append the sorted rows back to the tbody
            rows.forEach(row => tbody.appendChild(row));
        }

        // Function to navigate back to the main page
        function goBack() {
            window.location.href = '/'; // Update the URL as needed for your main page
        }

        // Call the function to fetch model data when the page loads
        window.onload = fetchModelData;
    </script>
</body>

</html>